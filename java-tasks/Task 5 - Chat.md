
# Задача 5. Интернет-чат

Напишите программу для общения через Internet. Программа должна состоять из двух частей: сервер и клиент. Сервер стартует в качестве отдельного приложения на определенном порту (задано в конфигурации). Клиент в виде GUI-приложения подсоединяется к серверу по имени сервера и номеру порта.

Минимальные возможности чата:

1. Каждый участник чата имеет собственный ник, который указывается при присоединению к серверу.
2. Можно посмотреть список участников чата.
3. Можно послать сообщение в чат (всем участникам).
4. Клиент показывыает все сообщения, которые отправили в чат с момента подключения + некоторое число, отправленных до; список сообщений обновляется в онлайне.
5. Клиент отображает такие события как: подключение нового человека в чат и уход человека из чата. Сервер должен корректно понимать ситуацию отключения клиента от чата (по таймауту).
6. Сервер должен логгировать все события, которые происходят на его стороне (включается/отключается в конфигурационном файле).
7. Чат работает через TCP/IP протокол.
8. Общение клиента и сервера происходит по стандартному протоколу, основанному на XML. Протокол описан ниже. Вы можете расширять его, но базовая реализация должна соответствовать описанию.

## Протокол взаимодействия

В начале каждого сообщения идут 4 байта (Java int) с его длиной. Вам нужно прочитать из сокета 4 байта, далее прочитать это количество байт. Это и будет сообщение, которое затем обрабатывается как XML документ. Типы сообщений приведены ниже.

1. Регистрация

    Client message
    ```xml
    <command name="login">
        <name>USER_NAME</name>
        <password>PASSWORD</password>
    </command>
    ```
    Server error answer
    ```xml
    <error>
        <message>REASON</message>
    </error>
    ```
    Server success answer
    ```xml
    <success></success>
    ```
    При первом логине пользователя сервер сохраняет его имя и криптографический хэш пароля. Сам пароль хранить нельзя! При последующих логинах, если хэш передаваемого пароля не совпадает с сохраненным, возвращается сообщение об ошибке, и сервер закрывает соединение.

    Все остальные команды возвращают ошибку, пока не произойдет успешный логин.

2. Запрос списка пользователей чата

    Client message
    ```xml
    <command name="list"></command>
    ```
    Server error answer
    ```xml
    <error>
        <message>REASON</message>
    </error>
    ```
    Server success answer
    ```xml
    <success>
        <users>
            <user>
                <name>USER_1</name>
            </user>
            ...
            <user>
                <name>USER_N</name>
            </user>
        </users>
    </success>
    ```

3. Сообщение от клиента серверу

    Client message
    ```xml
    <command name="message">
        <message>MESSAGE</message>
    </command>
    ```
    Server error answer
    ```xml
    <error>
        <message>REASON</message>
    </error>
    ```
    Server success answer
    ```xml
    <success></success>
    ```

4. Сообщение от сервера клиенту

    Server message
    ```xml
    <event name="message">
        <from>CHAT_NAME_FROM</from>
        <message>MESSAGE</message>
    </event>
    ```

5. Отключение

    Client message
    ```xml
    <command name="logout"></command>
    ```
    Server error answer
    ```xml
    <error>
        <message>REASON</message>
    </error>
    ```
    Server success answer
    ```xml
    <success></success>
    ```
    Также отключение происходит автоматически при закрытии клиентом соединения или ошибке соединения. Сервер должен корректно обрабатывать такую ситуацию.

6. Оповещение о новым клиенте (отправляется всем клиентам)

    Server message
    ```xml
    <event name="userlogin">
        <name>USER_NAME</name>
    </event >
    ```

7. Оповещение об отключении клиента (отправляется всем клиентам)

    Server message
    ```xml
    <event name="userlogout">
        <name>USER_NAME</name>
    </event>
    ```

## Дополнительно (оценка "4")

На оценку "4" и выше нужно реализовать возможность передачи файлов между пользователями. Визуально это должна быть кнопка, при нажатии на которую открывается диалог выбора файла. После выбора файла он отправляется на сервер, и в чате приходит уведомление, что такой-то пользователь отправил файл. Приводится имя файла и его размер. Каждый пользователь затем может файл скачать, кликнув по его имени в чате (или иным образом). При скачивании файла открывается диалог для указания, куда его сохранить на диске.

В протоколе передача файлов должна быть реализована так:

1. Отправка файла клиентом серверу

    Client message
    ```xml
    <command name="upload">
        <name>file name</name>
        <mimeType>text/plain</mimeType>
        <encoding>base64</encoding>
        <content>Base64-encoded file content</content>
    </command>
    ```
    Server error answer
    ```xml
    <error>
        <message>REASON</message>
    </error>
    ```
    Server success answer
    ```xml
    <success>
        <id>unique file ID</id>
    </success>
    ```
    Сервер сохраняет файл у себя и присваивает ему уникальный идентификатор. 

    Для определения MIME-типа файла вы можете воспользоваться методом `Files.probeContentType`, либо использовать стороннюю библиотеку.

2. Сообщение от сервера клиенту

    Server message
    ```xml
    <event name="file">
        <id>unique file ID</id>
        <from>CHAT_NAME_FROM</from>
        <name>file name</name>
        <size>file size in bytes</size>
        <mimeType>text/plain</mimeType>
    </event>
    ```
    Это сообщение сервер отправляет другим клиентам. Обратите внимание, что оно не включает содержимое файла. 

Если клиент хочет запросить содержимое файла, он делает это отдельным сообщением, и сервер в этом случае отвечает только этому клиенту. Это сделано для того, чтобы сэкономить трафик клиентов, ведь файлы могут быть большими.

1. Запросить файл у сервера

    Client message
    ```xml
    <command name="download">
        <id>unique file ID</id>
    </command>
    ```
    Server error answer
    ```xml
    <error>
        <message>REASON</message>
    </error>
    ```
    Server success answer
    ```xml
    <success>
        <id>unique file ID</id>
        <name>file name</name>
        <mimeType>text/plain</mimeType>
        <encoding>base64</encoding>
        <content>Base64-encoded file content</content>
    </success>
    ```

## Дополнительно (оценка "5")

На оценку "5" нужно реализовать требования для оценки "4", а также несколько дополнительных возможностей.

**Обязательные требования:**

1. Среди дополнительных возможностей обязательно должна быть хотя бы одна, расширяющая протокол общения между клиентом и сервером.
2. Любые расширения должны быть обратно совместимы с базовой версией. То есть, ваш клиент с новыми фичами должен правильно работать с сервером, который реализует только базовые возможности, а другие клиенты - нормально работать с вашим сервером. Например, добавлять новые поля в стандартные сообщения протокола можно, а удалять или изменять старые - нет.

Вы можете придумать свои улучшения или взять что-нибудь из списка ниже:

1. Поддержка форматирования сообщений: цвет шрифта и фона, жирный/курсив/подчеркивание, и т.д.
2. Если пользователь отправляет картинку как файл, то отобразить ее прямо в чате. Картинку можно определить по MIME-типу: `image/png`, `image/jpеg` и т.д. Формат должен поддерживаться как минимум один из этих двух.
3. Поддержка emoji.
4. Поддержка аватаров пользователей.
5. Возможность для пользователя ввести информацию о себе (профиль), а другим пользователям - ее посмотреть. Придумайте сами, какие поля будут в профиле.
6. Отдельное окно (область основного окна) на клиенте со списком всех файлов, имеющихся на сервере, и возможностью любой из них скачать.
7. Закачка произвольной части файла, а не файла целиком. Может понадобится для докачки большого файла после обрыва соединения.
8. Показывать индикатор прогресса закачки файла на клиенте.
9. Реализовать отдачу сервером файлов дополнительно по протоколу HTTP.
10. **Придумайте ваши собственные улучшения чата и реализуйте их!**
