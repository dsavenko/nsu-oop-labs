
# Задача 5. Интернет-чат

Напишите программу для общения через Internet. Программа должна состоять из двух частей: сервер и клиент. Сервер стартует в качестве отдельного приложения на определенном порту (задано в конфигурации). Клиент в виде GUI-приложения подсоединяется к серверу по имени сервера и номеру порта.

Минимальные возможности чата:

1. Каждый участник чата имеет собственный ник, который указывается при присоединении к серверу.
2. Можно посмотреть список участников чата.
3. Можно послать сообщение в чат (всем участникам).
4. Клиент показывыает все сообщения, которые отправили в чат с момента подключения + некоторое число, отправленных до; список сообщений обновляется в онлайне.
5. Клиент отображает такие события как: подключение нового человека в чат и уход человека из чата. Сервер должен корректно понимать ситуацию отключения клиента от чата (по таймауту).
6. Сервер должен логгировать все события, которые происходят на его стороне (включается/отключается в конфигурационном файле).
7. Чат работает через TCP/IP протокол.
8. Общение клиента и сервера происходит по стандартному тектовому протоколу, который описан ниже. Вы можете расширять его, но базовая реализация должна **строго** соответствовать описанию. Строгое следование протоколу нужно для того, чтобы ваш сервер мог работать с клиентами других людей, а ваш клиент - с другими серверами.

## Протокол взаимодействия

Основа протокола - обмен сообщениями в текстовом формате. Каждое сообщение состоит из нескольких свойств, также называемых полями. Каждое свойство - это строчка вида "Имя: значение" (строки разделяются символом `\n`). Например, `Command: login`, `Status: success` и т.д. (см. ниже). Пробел после `:` обязателен. Если значение свойства многострочное, то переводы строк сохраняются с добавлением 2-х пробелов в начале каждой новой строки:

```
Text: this is
  a multiline
  property value.
```

Каждое сообщение заканчивается пустой строкой, т.е. последовательностью символов `\n\n`. Для получения сообщения вы должны читать из сокета данные построчно, пока не прочитаете `\n\n`. А для отправки сообщения вы должны построчно записать в сокет все его свойства, после чего записать туда `\n\n`.

Имена свойств не зависят от регистра, т.е. `Command: login` и `cOmmANd: login` - это одно и то же свойство. Значения свойств зависят от регистра. 

Порядок свойств в сообщении не важен.

Стандартные сообщения их свойства, которые вы должны поддерживать, приведены ниже.

**Важно!** Ваши сервер и клиент должны игнорировать неизвестные (не описанные ниже) сообщения и свойства и продолжать корректно работать. Это нужно для того, чтобы работать с расширениями протокола (см. ниже).

## Основные сообщения (обязательны для реализации)

1. Регистрация

    Client message
    ```
    Command: login
    Name: USER_NAME
    Password: PASSWORD
    ```
    Server error answer
    ```
    Status: error
    Message: REASON
    ```
    Server success answer
    ```
    Status: success
    ```
    При первом логине пользователя сервер сохраняет его имя и криптографический хэш пароля. Сам пароль хранить нельзя! При последующих логинах, если хэш передаваемого пароля не совпадает с сохраненным, возвращается сообщение об ошибке, и сервер закрывает соединение.

    Все остальные команды возвращают ошибку, пока не произойдет успешный логин.

2. Запрос списка пользователей чата

    Client message
    ```
    Command: list
    ```
    Server error answer
    ```
    Status: error
    Message: REASON
    ```
    Server success answer
    ```
    Status: success
    UserCount: N
    UserName1: USER_1
    ...
    UserNameN: USER_N
    ```

3. Сообщение от клиента серверу

    Client message
    ```
    Command: message
    Message: MESSAGE
    ```
    Server error answer
    ```
    Status: error
    Message: REASON
    ```
    Server success answer
    ```
    Status: success
    ```

4. Сообщение от сервера клиенту

    Server message
    ```
    Event: message
    From: USER_NAME
    Message: MESSAGE
    ```

5. Отключение

    ```
    Command: logout
    ```
    Server error answer
    ```
    Status: error
    Message: REASON
    ```
    Server success answer
    ```
    Status: success
    ```
    Также отключение происходит автоматически при закрытии клиентом соединения или ошибке соединения. Сервер должен корректно обрабатывать такую ситуацию.

6. Оповещение о новым клиенте (отправляется всем клиентам)

    Server message
    ```
    Event: userlogin
    UserName: USER_NAME
    ```

7. Оповещение об отключении клиента (отправляется всем клиентам)

    Server message
    ```
    Event: userlogout
    UserName: USER_NAME
    ```

## Передача файлов (обязательно для реализации)

В дополнение к функциям обмена сообщениями нужно реализовать возможность передачи файлов между пользователями. Визуально это должна быть кнопка, при нажатии на которую открывается диалог выбора файла. После выбора файла он отправляется на сервер, и в чате приходит уведомление, что такой-то пользователь отправил файл. Приводится имя файла и его размер. Каждый пользователь затем может файл скачать, кликнув по его имени в чате (или иным образом). При скачивании файла открывается диалог для указания, куда его сохранить на диске.

В протоколе передача файлов должна быть реализована так:

1. Отправка файла клиентом серверу

    Client message
    ```
    Command: upload
    Name: FILE_NAME
    MimeType: MIME_TYPE
    Encoding: base64
    Content: Base64-encoded file content
    ```
    Server error answer
    ```
    Status: error
    Message: REASON
    ```
    Server success answer
    ```
    Status: success
    FileId: UNIQUE_FILE_ID
    ```
    Сервер сохраняет файл у себя и присваивает ему уникальный идентификатор (строку символов).

    Для определения MIME-типа файла вы можете воспользоваться методом `Files.probeContentType`, либо использовать стороннюю библиотеку. Например, для текстовых файлов MIME-тип будет `text/plain`.

2. Сообщение от сервера клиенту

    Server message
    ```
    Event: file
    FileId: UNIQUE_FILE_ID
    From: USER_NAME
    Name: FILE_NAME
    Size: FILE_SIZE_IN_BYTES
    MimeType: MIME_TYPE
    ```
    Это сообщение сервер отправляет другим клиентам. Обратите внимание, что оно не включает содержимое файла. 

Если клиент хочет запросить содержимое файла, он делает это отдельным сообщением, и сервер в этом случае отвечает только этому клиенту. Это сделано для того, чтобы сэкономить трафик клиентов, ведь файлы могут быть большими.

1. Запросить файл у сервера

    Client message
    ```
    Command: download
    FileId: UNIQUE_FILE_ID
    ```
    Server error answer
    ```
    Status: error
    Message: REASON
    ```
    Server success answer
    ```
    Status: success
    FileId: UNIQUE_FILE_ID
    Name: FILE_NAME
    MimeType: MIME_TYPE
    Encoding: base64
    Content: Base64-encoded file content
    ```

## Дополнительно

**Обязательные требования при реализации дополнительных возможностей:**
1. Среди дополнительных возможностей обязательно должна быть хотя бы одна, расширяющая протокол общения между клиентом и сервером.
2. Любые расширения протокола должны быть обратно совместимы с базовой версией. То есть, ваш клиент с новыми фичами должен правильно работать с сервером, который реализует только базовые возможности, а другие клиенты - нормально работать с вашим сервером. Например, можно добавлять новые сообщения в протокол или новые поля в стандартные сообщения, а вот удалять или изменять старые - нельзя.

Вы можете придумать свои улучшения или взять что-нибудь из списка ниже:

1. Поддержка форматирования сообщений: цвет шрифта и фона, жирный/курсив/подчеркивание, и т.д.
2. Если пользователь отправляет картинку как файл, то отобразить ее прямо в чате. Картинку можно определить по MIME-типу: `image/png`, `image/jpеg` и т.д. Формат должен поддерживаться как минимум один из этих двух.
3. Поддержка emoji.
4. Поддержка аватаров пользователей.
5. Возможность для пользователя ввести информацию о себе (профиль), а другим пользователям - её посмотреть. Придумайте сами, какие поля будут в профиле.
6. Поддержка личных сообщений от одного пользователя другому (не в общий чат).
7. Поддержка "комнат" чата. Есть дефолтная комната, куда попадают все пользователи после логина. Но можно создавать новые комнаты и присоединяться к ним.
8. Отдельное окно (или область основного окна) на клиенте со списком всех файлов, имеющихся на сервере, и возможностью любой из них скачать.
9. Закачка произвольной части файла, а не файла целиком. Может понадобится для докачки большого файла после обрыва соединения.
10. Показывать индикатор прогресса закачки файла на клиенте.
11. Реализовать отдачу сервером файлов дополнительно по протоколу HTTP.
12. **Придумайте ваши собственные улучшения чата и реализуйте их!**
